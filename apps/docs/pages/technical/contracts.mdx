# Smart Contracts

Reference documentation for the Stolen Wallet Registry contracts.

## Contract Addresses

| Network          | Address | Explorer                                                                     |
| ---------------- | ------- | ---------------------------------------------------------------------------- |
| Base             | `0x...` | [Basescan](https://basescan.org/address/0x...)                               |
| Optimism         | `0x...` | [Optimism Etherscan](https://optimistic.etherscan.io/address/0x...)          |
| Base Sepolia     | `0x...` | [Base Sepolia Scan](https://sepolia.basescan.org/address/0x...)              |
| Optimism Sepolia | `0x...` | [Optimism Sepolia Scan](https://sepolia-optimism.etherscan.io/address/0x...) |

_Note: Replace with actual deployed addresses_

## StolenWalletRegistry.sol

The main contract for wallet registration.

### Functions

#### acknowledge

Submit the first phase of registration.

```solidity
function acknowledge(
    address owner,
    uint256 deadline,
    uint256 nonce,
    uint8 v,
    bytes32 r,
    bytes32 s
) external
```

| Parameter  | Type    | Description                      |
| ---------- | ------- | -------------------------------- |
| `owner`    | address | Wallet being registered          |
| `deadline` | uint256 | Timestamp when signature expires |
| `nonce`    | uint256 | Current nonce for the owner      |
| `v`        | uint8   | Signature v component            |
| `r`        | bytes32 | Signature r component            |
| `s`        | bytes32 | Signature s component            |

**Emits:** `WalletAcknowledged(address indexed owner, address indexed forwarder, bool indexed isSponsored)`

**Reverts:**

- `Acknowledgement__InvalidSigner` - Signature doesn't match owner
- `Acknowledgement__Expired` - Deadline has passed
- `InvalidNonce` - Nonce mismatch

---

#### register

Submit the second phase of registration.

```solidity
function register(
    address owner,
    uint256 deadline,
    uint256 nonce,
    uint8 v,
    bytes32 r,
    bytes32 s
) external payable
```

| Parameter  | Type    | Description                      |
| ---------- | ------- | -------------------------------- |
| `owner`    | address | Wallet being registered          |
| `deadline` | uint256 | Timestamp when signature expires |
| `nonce`    | uint256 | Current nonce for the owner      |
| `v`        | uint8   | Signature v component            |
| `r`        | bytes32 | Signature r component            |
| `s`        | bytes32 | Signature s component            |

**Value:** Registration fee (if required)

**Emits:** `WalletRegistered(address indexed owner, bool indexed isSponsored)`

**Reverts:**

- `Registration__InvalidSigner` - Signature doesn't match owner
- `Registration__InvalidForwarder` - Caller isn't the trusted forwarder
- `Registration__GracePeriodNotStarted` - Too early to register
- `Registration__ForwarderExpired` - Registration window closed
- `InsufficientFee` - Not enough ETH sent

---

#### generateHashStruct

Get the deadline and hash for signing.

```solidity
function generateHashStruct(
    address forwarder,
    uint8 step
) external view returns (uint256 deadline, bytes32 hashStruct)
```

| Parameter   | Type    | Description                              |
| ----------- | ------- | ---------------------------------------- |
| `forwarder` | address | Address that will submit the transaction |
| `step`      | uint8   | 1 = acknowledgement, 2 = registration    |

**Returns:**

- `deadline` - Timestamp when signature expires
- `hashStruct` - EIP-712 struct hash (for verification)

---

#### isRegistered

Check if a wallet is registered.

```solidity
function isRegistered(address wallet) external view returns (bool)
```

---

#### nonces

Get the current nonce for a wallet.

```solidity
function nonces(address owner) external view returns (uint256)
```

---

#### getAcknowledgement

Get the acknowledgement data for a wallet.

```solidity
function getAcknowledgement(address wallet) external view returns (
    AcknowledgementData memory data
)
```

**AcknowledgementData struct:**

```solidity
struct AcknowledgementData {
    address forwarder;
    uint256 graceEndBlock;
    uint256 deadlineBlock;
}
```

### Events

#### WalletAcknowledged

```solidity
event WalletAcknowledged(
    address indexed owner,
    address indexed forwarder,
    bool indexed isSponsored
);
```

Emitted when acknowledgement phase completes.

#### WalletRegistered

```solidity
event WalletRegistered(
    address indexed owner,
    bool indexed isSponsored
);
```

Emitted when registration completes.

### Errors

```solidity
// Acknowledgement errors
error Acknowledgement__Expired();
error Acknowledgement__InvalidSigner();

// Registration errors
error Registration__SignatureExpired();
error Registration__InvalidSigner();
error Registration__InvalidForwarder();
error Registration__GracePeriodNotStarted();
error Registration__ForwarderExpired();

// General errors
error InvalidOwner();
error InvalidNonce();
error InsufficientFee();
error AlreadyRegistered();
error FeeForwardFailed();
error UnauthorizedCaller();
error InvalidBridgeId();
error InvalidChainId();
error InvalidTimingConfig();
error InvalidFeeConfig();
```

## TimingConfig.sol

Utility library for timing calculations with randomization.

### Functions

#### getGracePeriodEndBlock

```solidity
function getGracePeriodEndBlock(uint256 graceBlocks) internal view returns (uint256)
```

Returns the block number when the grace period ends. Computes `block.number + graceBlocks + random(0, graceBlocks)` using `block.prevrandao` for randomization.

#### getDeadlineBlock

```solidity
function getDeadlineBlock(uint256 deadlineBlocks) internal view returns (uint256)
```

Returns the block number when the registration window expires. Computes `block.number + deadlineBlocks + random(0, deadlineBlocks)` using `block.prevrandao` for randomization.

#### getSignatureDeadline

```solidity
function getSignatureDeadline() internal view returns (uint256)
```

Returns `block.timestamp + 10 minutes` as the signature expiration timestamp.

## Integration Examples

### Reading Contract State

```typescript
import { createPublicClient, http } from 'viem';
import { base } from 'viem/chains';
import { stolenWalletRegistryAbi } from '@swr/abis';

const client = createPublicClient({
  chain: base,
  transport: http(),
});

// Check if wallet is registered
const isRegistered = await client.readContract({
  address: '0x...',
  abi: stolenWalletRegistryAbi,
  functionName: 'isRegistered',
  args: ['0xWalletAddress'],
});

// Get current nonce
const nonce = await client.readContract({
  address: '0x...',
  abi: stolenWalletRegistryAbi,
  functionName: 'nonces',
  args: ['0xWalletAddress'],
});
```

### Writing to Contract

```typescript
import { createWalletClient, custom } from 'viem';
import { base } from 'viem/chains';

const walletClient = createWalletClient({
  chain: base,
  transport: custom(window.ethereum),
});

// Submit acknowledgement
const hash = await walletClient.writeContract({
  address: '0x...',
  abi: stolenWalletRegistryAbi,
  functionName: 'acknowledge',
  args: [owner, deadline, nonce, v, r, s],
});
```

### Listening to Events

```typescript
import { createPublicClient, http, parseAbiItem } from 'viem';
import { base } from 'viem/chains';

const client = createPublicClient({
  chain: base,
  transport: http(),
});

// Watch for registrations
const unwatch = client.watchContractEvent({
  address: '0x...',
  abi: stolenWalletRegistryAbi,
  eventName: 'WalletRegistered',
  onLogs: (logs) => {
    for (const log of logs) {
      console.log('Wallet registered:', log.args.owner);
    }
  },
});
```

### Using wagmi Hooks

```typescript
import { useReadContract, useWriteContract } from 'wagmi';

// Read
const { data: isRegistered } = useReadContract({
  address: '0x...',
  abi: stolenWalletRegistryAbi,
  functionName: 'isRegistered',
  args: [walletAddress],
});

// Write
const { writeContract } = useWriteContract();

writeContract({
  address: '0x...',
  abi: stolenWalletRegistryAbi,
  functionName: 'register',
  args: [owner, deadline, nonce, v, r, s],
  value: parseEther('0.005'), // If fee required
});
```

## Future: ISubRegistry Interface

The planned interface for subregistries:

```solidity
interface ISubRegistry {
    function register(
        bytes32 identifier,
        bytes calldata proof,
        uint256 deadline
    ) external payable returns (bool);

    function isRegistered(
        bytes32 identifier
    ) external view returns (bool);

    function getRegistrationData(
        bytes32 identifier
    ) external view returns (RegistrationData memory);

    function registryType() external pure returns (bytes32);
}
```

## Future: RegistryHub

Central hub for routing to subregistries:

```solidity
contract RegistryHub is Ownable2Step {
    mapping(bytes32 => address) public subRegistries;

    function registerToSubRegistry(
        bytes32 registryType,
        bytes32 identifier,
        bytes calldata proof,
        uint256 deadline
    ) external payable {
        ISubRegistry(subRegistries[registryType]).register{value: msg.value}(
            identifier,
            proof,
            deadline
        );
    }
}
```

## Development

### Build Contracts

```bash
pnpm forge:build
```

### Run Tests

```bash
pnpm forge:test
```

### Deploy Locally

```bash
pnpm anvil        # Terminal 1
pnpm deploy:dev   # Terminal 2
```

### Generate ABIs

ABIs are automatically generated and exported from `@swr/abis`:

```typescript
import { stolenWalletRegistryAbi, stolenWalletRegistryAddress } from '@swr/abis';
```
