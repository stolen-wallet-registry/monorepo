# Etherscan Walkthrough

Register a stolen wallet directly through Etherscan (or Basescan) without using the web app.

> **Security Warning:** Interacting with contracts directly on Etherscan bypasses the frontend's input validation and user experience safeguards. Double-check all values before signing. If you make an error, you may need to restart the registration process.

## When to Use

Use Etherscan registration when:

- The web app is unavailable
- You prefer interacting with contracts directly
- You want to verify exactly what you're signing
- You're integrating programmatically

## Prerequisites

- Web3 wallet with sufficient ETH
- The contract address on your network
- Basic familiarity with Etherscan's "Write Contract" interface

## Contract Addresses

| Network          | Address | Explorer                                                                     |
| ---------------- | ------- | ---------------------------------------------------------------------------- |
| Base Sepolia     | `0x...` | [Base Sepolia Scan](https://sepolia.basescan.org/address/0x...)              |
| Optimism Sepolia | `0x...` | [Optimism Sepolia Scan](https://sepolia-optimism.etherscan.io/address/0x...) |

_Note: Replace with actual deployed addresses_

## Step 1: Get Your Signature Parameters

Before interacting with the contract, you need to generate the required values.

### Option A: Use the App's Signature Generator

1. Go to the web app
2. Start a registration (any method)
3. Before signing, open browser dev tools (F12)
4. Find the typed data in the console logs
5. Copy the `deadline`, `nonce`, and other values

### Option B: Query the Contract

Read from the contract to get your current nonce and deadline:

1. Go to the contract on Etherscan
2. Click "Read Contract"
3. Find `nonces(address owner)` and enter your wallet address
4. Note your current nonce (you'll need this for signing)
5. Find `generateHashStruct(address forwarder, uint8 step)`
   - `forwarder`: Your wallet address (same as owner for standard registration)
   - `step`: Enter `1` for acknowledgement, `2` for registration
   - Note the `deadline` and `hashStruct` from the result

## Step 2: Generate EIP-712 Signature

You need to sign an EIP-712 typed data message. This can be done with:

### Using ethers.js

```javascript
const domain = {
  name: 'StolenWalletRegistry',
  version: '4',
  chainId: 84532, // Base Sepolia (use 8453 for Base mainnet)
  verifyingContract: '0x...', // Contract address from table above
};

const types = {
  AcknowledgementOfRegistry: [
    { name: 'owner', type: 'address' },
    { name: 'forwarder', type: 'address' },
    { name: 'nonce', type: 'uint256' },
    { name: 'deadline', type: 'uint256' },
  ],
};

const message = {
  owner: '0xYourWalletAddress',
  forwarder: '0xYourWalletAddress', // Same for standard registration
  nonce: 0, // Your current nonce
  deadline: 1234567890, // From generateHashStruct
};

const signature = await signer.signTypedData(domain, types, message);
```

### Using viem

```typescript
const signature = await walletClient.signTypedData({
  domain: {
    name: 'StolenWalletRegistry',
    version: '4',
    chainId: 84532, // Base Sepolia (use 8453 for Base mainnet)
    verifyingContract: '0x...',
  },
  types: {
    AcknowledgementOfRegistry: [
      { name: 'owner', type: 'address' },
      { name: 'forwarder', type: 'address' },
      { name: 'nonce', type: 'uint256' },
      { name: 'deadline', type: 'uint256' },
    ],
  },
  primaryType: 'AcknowledgementOfRegistry',
  message: {
    owner: '0xYourWalletAddress',
    forwarder: '0xYourWalletAddress',
    nonce: 0n,
    deadline: 1234567890n,
  },
});
```

### Using cast (Foundry)

Create a `typed-data.json` file with your EIP-712 payload:

```json
{
  "domain": {
    "name": "StolenWalletRegistry",
    "version": "4",
    "chainId": 8453,
    "verifyingContract": "0x..."
  },
  "types": {
    "EIP712Domain": [
      { "name": "name", "type": "string" },
      { "name": "version", "type": "string" },
      { "name": "chainId", "type": "uint256" },
      { "name": "verifyingContract", "type": "address" }
    ],
    "AcknowledgementOfRegistry": [
      { "name": "owner", "type": "address" },
      { "name": "forwarder", "type": "address" },
      { "name": "nonce", "type": "uint256" },
      { "name": "deadline", "type": "uint256" }
    ]
  },
  "primaryType": "AcknowledgementOfRegistry",
  "message": {
    "owner": "0xYourWalletAddress",
    "forwarder": "0xYourWalletAddress",
    "nonce": "0",
    "deadline": "1234567890"
  }
}
```

Then sign:

```bash
cast wallet sign --private-key $PRIVATE_KEY --data --from-file typed-data.json
```

## Step 3: Submit Acknowledgement on Etherscan

1. Go to the contract on Etherscan
2. Click "Write Contract"
3. Connect your wallet
4. Find `acknowledge` function
5. Enter the parameters:

| Parameter  | Value                              |
| ---------- | ---------------------------------- |
| `owner`    | Your wallet address                |
| `deadline` | Deadline from step 1               |
| `nonce`    | Your current nonce from step 1     |
| `v`        | Signature v value (27 or 28)       |
| `r`        | Signature r value (first 32 bytes) |
| `s`        | Signature s value (last 32 bytes)  |

### Extracting v, r, s from Signature

Using viem (recommended):

```typescript
import { hexToSignature } from 'viem';

const { v, r, s } = hexToSignature(signature);
// v is already normalized to 27/28
```

Manual extraction:

```javascript
// From a 65-byte signature
const r = '0x' + signature.slice(2, 66);
const s = '0x' + signature.slice(66, 130);
let v = parseInt(signature.slice(130, 132), 16);
// Normalize v: some wallets return 0/1, contract expects 27/28
if (v < 27) v += 27;
```

6. Click "Write"
7. Confirm the transaction

## Step 4: Wait for Grace Period

After the acknowledgement transaction is mined:

1. Check the transaction for the `WalletAcknowledged` event
   - Fields: `owner` (indexed), `forwarder` (indexed), `isSponsored` (indexed)
2. Query the contract state to get timing values:
   - Go to "Read Contract" on Etherscan
   - Call `getAcknowledgement(address wallet)` with your wallet address
   - Note the `graceEndBlock` and `deadlineBlock` from the returned data
3. Wait until the current block number is >= `graceEndBlock`
4. You have until `deadlineBlock` to complete registration

You can monitor blocks at [Basescan](https://basescan.org) or via:

```bash
cast block-number --rpc-url https://mainnet.base.org
```

## Step 5: Generate Registration Signature

Similar to step 2, but use `Registration` type:

```javascript
const types = {
  Registration: [
    { name: 'owner', type: 'address' },
    { name: 'forwarder', type: 'address' },
    { name: 'nonce', type: 'uint256' },
    { name: 'deadline', type: 'uint256' },
  ],
};

// Note: Query nonces(owner) again - it incremented after acknowledgement
const message = {
  owner: '0xYourWalletAddress',
  forwarder: '0xYourWalletAddress',
  nonce: 1, // Query contract for current nonce (previous + 1)
  deadline: newDeadline, // From generateHashStruct(forwarder, 2)
};
```

## Step 6: Submit Registration on Etherscan

1. Go to "Write Contract"
2. Find `register` function
3. Enter the parameters (similar to step 3)
4. Add any required ETH value (registration fee)
5. Click "Write"
6. Confirm the transaction

## Step 7: Verify Registration

After the registration transaction is mined:

1. Go to "Read Contract"
2. Find `isRegistered(address)`
3. Enter your wallet address
4. Should return `true`

Or check the events:

1. Go to the transaction
2. Look for `WalletRegistered`
3. Verify your address is in the logs

## Common Errors

### "Acknowledgement**InvalidSigner" / "Registration**InvalidSigner"

The signature doesn't match the owner address. Check:

- Correct domain parameters (name, version, chainId, verifyingContract)
- Correct message parameters (owner, forwarder, nonce, deadline)
- You signed with the correct wallet

### "Acknowledgement**Expired" / "Registration**SignatureExpired"

The deadline has passed or is invalid. Get a fresh deadline from `generateHashStruct(forwarder, step)`.

### "InvalidNonce"

You've used an incorrect nonce. Check your current nonce with `nonces(owner)`.

### "Registration\_\_GracePeriodNotStarted"

You're trying to register before the grace period ends. Check `getAcknowledgement(wallet)` for `graceEndBlock`.

### "Registration\_\_ForwarderExpired"

The registration window has closed. You'll need to restart from acknowledgement.

## Programmatic Integration

For integrating into your own systems:

```typescript
import { createPublicClient, createWalletClient, http } from 'viem';
import { base } from 'viem/chains';

const publicClient = createPublicClient({
  chain: base,
  transport: http(),
});

// Read nonce
const nonce = await publicClient.readContract({
  address: contractAddress,
  abi: stolenWalletRegistryAbi,
  functionName: 'nonces',
  args: [walletAddress],
});

// Get deadline
const [deadline, hashStruct] = await publicClient.readContract({
  address: contractAddress,
  abi: stolenWalletRegistryAbi,
  functionName: 'generateHashStruct',
  args: [walletAddress, 1], // 1 = acknowledgement
});

// Sign and submit...
```

## Next Steps

- [Smart Contract Reference](/technical/contracts)
- [EIP-712 Signature Details](/technical/eip712-signatures)
- [Return to Quick Start](/guide)
